# Modu-Messenger Android

## 통신 관련

안드로이드는 백엔드 서버와 통신은 rest api를 사용   
주로 3개의 라이브러리가 많이 사용  

`HttpURLConnection, HttpsURLConnection`  
* 자바 기본 제공 라이브러리
* 기본 라이브러리이다 보니 코드 사용량이 매우 많아짐
* 커넥션 관리 까지 가능하고 다양한 옵션 사용 가능
* 만약 쓴다면 한번 래핑 해서 사용하는게 좋아보임

`OkHttp`  
* "Square"라는 회사가 만든 라이브러리
* 사용법이 간단해보임 (Builder 사용)
* 동기, 비동기 방식 전부 사용가능

`Retrofit`  
* 위의 OkHttp를 좀더 사용하기 편하게 다듬은 라이브러리
* 가장 최근에 만들어진 라이브러리
* 많은 사람들이 사용하고 있는것으로 보임

Retrofit을 이용하여 백엔드와 통신하는 것으로 결정

## 프로필 관련 기능

프로필 사진, 상태 메시지 지원   
예정) 프로필 사진 업데이트 기능 지원   

## 메신저 기능 관련

웹 소켓을 이용한 메시징 기능 구현   

일반 메세지 (텍스트) 전송 가능   
예정) 기타 메세지 (사진, 파일 등) 지원 예정  

## 안드로이드 Q(API 29) 의 Scoped Storage

안드로이드 Q(Api 29)에서 보안 및 저장 공간의 효율화를 위해서 Scoped Storage가 추가되었다.  
내부저장소의 경우 기존과 동일하지만 외부저장소의 경우 이전과 달라졌다.  
외부저장소의 경우 개별공간이 앱별로 샌드박스로 격리되도록 변경되었다.  
또한 외부저장소의 공용공간도 음악, 동영상, 다운로드로 분리되었다.  
분리된 음악, 동영상, 다운로드 구조 내부에서 또 앱 패키지 별로 또 구분되도록 변경되었다.  

채팅으로 사진을 전송할때, 갤러리에서 사진을 선택하고 서버로 전송해야 한다.  
Q 이전 버전에서 사용하던 MediaStore의 방식이 Deprecated 되었다.  
따라서 갤러리의 이미지를 내부 저장소에 복사한다음, 이파일 경로를 서버로 업로드 한다.  
이때 생성한 내부저장소의 임시파일은 전송후 삭제한다.  

## 채팅방 Infinite Scroll

채팅방에서 주고 받은 채팅이 100개 라면 한번에 조회시 부하가 크게 발생하지 않을 것이다.  
하지만 채팅이 100개가 아니라 천개, 만개 혹은 그 이상이라면 전체 조회시에 로딩이 길어질 것이다.  
따라서 채팅방에 입장하면 초기에 보여질 채팅을 우선적으로 가져와서 보여준다.  
그리고 이전 내역을 조회 해야하는 경우에만 이전 채팅을 가져오는 방식으로 구현을 하였다.  

이전 채팅을 가져오는 기준은 채팅 각각이 가지고 있는 아이디를 기준으로 한다.  
현재 표시된 가장 마지막 채팅의 아이디가 123이면 123 이전의 아이디를 조회해서 가져온다.  
이전 내역을 조회해야 하는 경우는 보여진 채팅을 전부 보고 난 뒤 이다. (스크롤이 끝에 도달한 경우)  

채팅은 위아래 두가지 방향에서 추가 될수 있다. (위 - 이전 채팅, 아래 - 신규 채팅)   
이전 채팅 내역을 추가하는 경우는 채팅 리스트의 맨 앞에 추가해야한다.  
그리고 새롭게 전송되는 채팅은 채팅 리스트의 맨 뒤에 추가되어야 한다.  

이때 보여지는 어떻게 기준을 가지고 새 채팅을 추가하고, 이전 채팅을 가져와야 하는지 헷갈릴 수 있다.  
근데 잘생각해보면 두 데이터는 서로 간섭을 하지않는다. 입장하면서 가져온 채팅 리스트를 기준으로만 생각하면 된다.  
이전 채팅을 가져오는 채팅의 id는 이전 채팅을 조회할때마다 갱신된다. (가장 마지막 표시된 채팅의 id)  
그렇게 해서 가져온 이전 채팅들은 리스트의 맨 앞에만 추가된다. (순서상으로 앞에 있기 때문이다)  
그리고 새롭게 전송되는 채팅은 조회해서 가져온 채팅 리스트의 마지막에 계속 추가된다.   
채팅의 경우 순차적인 데이터 이므로 중간에 삽입되는 일이 절대로 없다. (수정이나, 삭제는 가능, 삽입만 없음)  

## 오프라인 모드

오프라인 모드를 지원  
내장 데이터 베이스에 채팅 내역, 친구 리스트등을 저장  
백그라운드에서 네트워크 연결 상태를 주기적으로 체크   
오프라인 모드 지원함에 따라 요청받은 데이터는 모두 로컬 데이터 베이스에 저장   
ui에 데이터 표시할때는 로컬 데이터 베이스의 데이터를 기반으로 표시    
최신 데이터 동기화 주기에 대한 고려 필요 (서버의 부하 감소)   
채팅 전송등의 기능 사용 불가   
채팅 목록 보기, 친구 프로필 보기 등의 기능은 사용 가능   

## SQLite, RoomDatabase

sqlite 의 경우 쿼리를 직접 작성 (오류발생시 런타임에 확인 가능)  
Room Databased의경우 SQLite 를 사용하기 쉽게 래핑한 라이브러리   
엔티티를 선언하고 JPQL 정도의 쿼리만을 작성함 (오류 발생시 컴파일 타임에 확인 가능)
버전 기록을 통해 migraiton이 용이함

## (예정) 알림 관련

파이어 베이스를 연동하여 푸쉬 알림 기능 구현 예정  
메세지를 백엔드에 전송 및 정상 수신시 채팅 방 내 다른 친구에게 푸시 알림 전송  

## 인증 관련

JWT 토큰을 이용한 인증 방식 사용  
백엔드에서 발급한 토큰을 앱 내부에서 저장하여 사용  